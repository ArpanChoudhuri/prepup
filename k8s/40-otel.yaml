apiVersion: apps/v1
kind: Deployment
metadata: { name: otel-collector, namespace: prepup }
spec:
  replicas: 1
  selector: { matchLabels: { app: otel-collector } }
  template:
    metadata: { labels: { app: otel-collector } }
    spec:
      containers:
        - name: otelcol
          image: otel/opentelemetry-collector:0.100.0
          args: ["--config=/etc/otel/config.yaml"]
          volumeMounts:
            - name: config
              mountPath: /etc/otel
          ports:
            - { name: otlp-http, containerPort: 4318 }
      volumes:
        - name: config
          configMap:
            name: otel-config
---
apiVersion: v1
kind: ConfigMap
metadata: { name: otel-config, namespace: prepup }
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          http:
    exporters:
      jaeger:
        endpoint: "jaeger-collector.prepup.svc.cluster.local:14250"
        tls: { insecure: true }
      logging: {}
    processors:
      batch: {}
    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [batch]
          exporters: [jaeger,logging]
---
apiVersion: v1
kind: Service
metadata: { name: otel-collector, namespace: prepup }
spec:
  selector: { app: otel-collector }
  ports:
    - { name: otlp-http, port: 4318, targetPort: 4318 }
---
apiVersion: apps/v1
kind: Deployment
metadata: { name: jaeger, namespace: prepup }
spec:
  replicas: 1
  selector: { matchLabels: { app: jaeger } }
  template:
    metadata: { labels: { app: jaeger } }
    spec:
      containers:
        - name: jaeger
          image: jaegertracing/all-in-one:1.57
          ports:
            - { name: ui, containerPort: 16686 }
            - { name: grpc, containerPort: 14250 }
---
apiVersion: v1
kind: Service
metadata: { name: jaeger-ui, namespace: prepup }
spec:
  selector: { app: jaeger }
  ports:
    - { name: http, port: 16686, targetPort: 16686 }
  type: ClusterIP
